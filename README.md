

---

# Mutation Analysis Workflow

## Overview

This project provides a comprehensive workflow for mutation data analysis, including **IMD distribution analysis**, **background model generation**, and **data preprocessing**. Users can utilize this tool to automate mutation data processing, construct background models, and calculate analytical metrics such as recommended thresholds, mutation burden, and false discovery rates (FDR).

---

## Modules

### Main Module
- **Function**: The main program orchestrates the core analysis workflow.
- **Input Parameters**:
  - `genome_size_bp`: Genome size in base pairs (e.g., GRCh37 = 3095693983)
  - `output_directory`: Path for simulated background model output
  - `input_file`: Path to input mutation file
  - `outfile_name`: Path for result file (CMCS-ready format)
  - `genome`: Genome version (e.g., GRCh37 or GRCh38)
  - `cancer_type`: Cancer type (e.g., BRCA)
- **Output**:
  - **IMD Distribution Plot**: Visualization comparing real and simulated IMD distributions.
  - **Recommended Threshold (eps)**: Automatically calculates the optimal IMD threshold.
  - **Mutation Burden**: Number of mutations per megabase.
  - **False Discovery Rate (FDR)**: Reflects the reliability of the background model.

---

### Pretreatment Module
- **Function**: Automates processing of mutation files downloaded from the COSMIC database.
  - Retains only single base substitutions (SBS).
  - Enriches data with trinucleotide context information via remote loading.
- **Output**:
  - Processed mutation data files meeting CMCS platform format requirements (with context information).

---

### Background Model Module
- **Function**: Generates simulated mutation data resembling real data distributions, ensuring biological plausibility.
- **Core Features**:
  1. **Chromosomal Proportion and Length Constraints**: Mutation positions are generated based on chromosomal mutation proportions and physical constraints.
  2. **IMD Distribution KDE**: A kernel density estimation (KDE) model is built from real data IMD values to simulate local clustering characteristics.
  3. **Hotspot Regions**: High-density mutation regions (e.g., top 20%) are prioritized for mutation generation.
  4. **Dynamic Starting Points and Incremental Positioning**: Mutation positions are generated by accumulating IMD values from either hotspot or random starting points.
  5. **Randomness and Reproducibility**: Random seeds (`random_state`) are used to ensure reproducibility while retaining randomness in simulations.
  6. **Multiple Simulations**: A total of 1,000 simulated datasets are generated to compute statistical features (e.g., mean cluster count), reducing variability.

---

## Installation and Execution

### Install Dependencies
Run the following command to install all required dependencies:
```bash
pip install -r requirements.txt

---

## Run the Main Module

### Modify parameters in `main()`:
```python
genome_size_bp = 3095693983  # Genome size for GRCh37
output_directory = "./simulations_output"
input_file = "./input_file/example/Cosmic_GenomeScreensMutant_Tsv_v99_GRCh37_PD4103a.tsv"
outfile_name = "./output_file/Tsv_v99_GRCh37_PD4103a_BRCA.tsv"
genome = "GRCh37"
cancer_type = "BRCA"


Then run the program:
python main.py

---

##Generated Results：
IMD Distribution Plot: Automatically generated as part of the analysis.
Result File: Saved at the path specified by outfile_name.
Console Output: Mutation burden and false discovery rate (FDR).

##Outputs：
IMD Distribution Plot: Visual comparison of real vs. simulated data.
Threshold IMD (eps): Recommended threshold value for cluster detection.
Mutation Burden: Total mutations per megabase.
False Discovery Rate (FDR): A statistical measure of model reliability.




























---

背景模型原理
这个背景模型生成的核心是结合真实数据特征，通过以下措施提升模拟数据的真实性和可靠性：
染色体分布比例和长度限制：确保突变在染色体上的分布与真实数据一致。
IMD分布的核密度估计：模拟突变点的局部分布特性。
热点区域模拟：优先在突变密集区域生成突变，反映真实热点特性。
动态起始点和随机间距累加：在热点区域和随机分布之间平衡。
多次模拟：通过多次重复生成降低随机性波动。
1. 染色体分布比例
特征来源： 模拟背景模型根据真实数据中每条染色体的突变比例分布生成数据。
实现方式： 使用 df['Chromosome'].value_counts(normalize=True) 计算真实数据中突变分布在各染色体上的比例，并据此确定每条染色体的突变数量。
意义： 确保模拟数据中每条染色体的突变数量与真实数据一致。
2. 染色体长度范围
特征来源： 根据指定基因组版本（如 GRCh37 或 GRCh38）的染色体大小，限制突变点的位置不超过染色体的物理范围。
实现方式： 使用染色体大小字典 chromosome_sizes_dict，确保突变位置在 [1, 染色体长度] 之间。
意义： 保证模拟数据符合基因组实际结构。
3. IMD（突变间距）分布
特征来源： 真实数据中相邻突变点的距离（IMD）。
实现方式：
使用真实数据计算IMD分布：x.sort_values().diff().dropna()
利用核密度估计（KDE，gaussian_kde）建模IMD分布，并从中抽样生成突变间距。
意义： 确保模拟数据的突变点分布间距与真实数据相似，反映突变的局部分布特性。
4. 热点区域分布
特征来源： 真实数据中的突变热点区域（如特定基因区域或密集突变区域）。
实现方式：
从真实数据中抽样部分高密度突变点作为热点区域（假设20%的突变点为热点）。
在模拟突变中优先从这些热点区域开始生成突变点。
意义： 模拟数据中保留真实突变数据的热点分布特性，同时结合随机性覆盖其他区域。
5. 动态起始点和累加生成突变位置
特征来源： 每条染色体的突变起始点和位置分布。
实现方式：
从热点区域或随机位置中抽样起始点。
通过累加IMD生成模拟突变位置。
意义： 确保突变点分布不仅具有全局一致性，还能反映染色体局部特性。
6. 多样化的随机性和重复性控制
特征来源： 模拟数据的随机性和可重复性。
实现方式：
对IMD分布的抽样使用核密度估计，使间距分布带有随机性。
对热点区域的抽样使用固定随机种子（random_state）控制，保证生成数据的可重复性。
意义： 兼顾随机性和可控性，使得模拟背景具有生物学可信度。
7. 多次重复模拟
特征来源： 模拟数据的统计稳定性。
实现方式： 生成多个（如1000个）模拟数据集，并用于计算簇数量均值等统计特性。
意义： 降低单次模拟数据的随机波动对后续分析的影响。


